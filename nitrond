#!/bin/bash
#
# Copyright (C) 2022~2023 UsiFX <xprjkts@gmail.com>
#
# This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License
#
# This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#

### Local Variables

# \e colors
BLUE='\e[1;34m'
GREEN='\e[1;32m'
PURPLE='\e[1;35m'
CYAN='\e[1;36m'
RED='\e[1;31m'
WHITE='\e[1;37m'
YELLOW='\e[01;33m'
STOCK='\e[1;0m'

NITRON_LOG_DIR='/cache'
PROMPT_COMMAND='sync'

### Debugging
set -x

### include headers
if [[ ! $(pwd)/nitron_headers.sh ]]
then
	echo "missing header, $(pwd)/nitron_headers.sh"
	exit 1
else
	source $(pwd)/nitron_headers.sh
fi

### Funcs
printn()
{
  while getopts ":n:e:w:i:" printn_opts; do
    case "${printn_opts}" in
      n) printf "[${BLUE}*${STOCK}] $2\n" ;;
      e) printf "[${RED}Ã—${STOCK}] $2\n"; return 1 ;;
      w) printf "[${YELLOW}!${STOCK}] $2\n" ;;
      i) printf "[${CYAN}i${STOCK}] $2 \n" ;;
    esac
  done
}

writen()
{
  if [[ ! -f $1 ]]
  then
    # Return in non existence
    echo "[$(date +%I:%M:%S)] $0: $1: not found, skipping..." >> $NITRON_LOG_DIR/nitron.log
    return 1
  fi

  # Gain access to write files
  chmod +w "$1" 2>/dev/null

  # Write the new value, Return in error
  if ! echo "$2" > "$1" 2>/dev/null
  then
    echo "[$(date +%I:%M:%S)] $0: $1: changing node returned with $?" >> $NITRON_LOG_DIR/nitron.log
    return $?
  else
    echo "[$(date +%I:%M:%S)] $0: $1: changed node[$2]: returned with $?" >> $NITRON_LOG_DIR/nitron.log
    return $?
  fi
}

__magicn_help()
{
cat <<EOF
Usage: magicn [-g|-r|-y|-h]

Options:
 -g, --green   ~ switch to user friendly tunables
 -r, --red     ~ switch to hardcore mode
 -y, --yellow  ~ switch to balance focusment
 -h, --help    ~ prints this menu
EOF
}

magicn()
{
	set_gaming_mode()
	{
		resetprop ro.nitron.mode red
		writen /proc/sys/kernel/perf_cpu_time_max_percent 20
		writen /proc/sys/kernel/sched_autogroup_enabled 0
		writen /proc/sys/kernel/sched_child_runs_first 0
		writen /proc/sys/kernel/sched_tunable_scaling 0
		writen /proc/sys/kernel/sched_migration_cost_ns 5000000
		writen /proc/sys/kernel/sched_nr_migrate 128
		writen /proc/sys/kernel/sched_schedstats 0
		writen /proc/sys/kernel/printk_devkmsg off
		writen /proc/sys/vm/dirty_background_ratio 15
		writen /proc/sys/vm/dirty_ratio 30
		writen /proc/sys/vm/dirty_expire_centisecs 3000
		writen /proc/sys/vm/dirty_writeback_centisecs 3000
		writen /proc/sys/vm/page-cluster 0
		writen /proc/sys/vm/stat_interval 10
		writen /proc/sys/vm/swappiness 100
		writen /proc/sys/vm/vfs_cache_pressure 80
		writen /proc/sys/net/ipv4/tcp_ecn 1
		writen /proc/sys/net/ipv4/tcp_fastopen 3
		writen /proc/sys/net/ipv4/tcp_syncookies 0
		writen /sys/module/ged/parameters/gx_game_mode 1
		writen /sys/module/ged/parameters/gx_force_cpu_boost 1
		writen /sys/module/ged/parameters/boost_amp 1
		writen /sys/module/ged/parameters/boost_extra 1
		writen /sys/module/ged/parameters/boost_gpu_enable 1
		writen /sys/module/ged/parameters/enable_cpu_boost 1
		writen /sys/module/ged/parameters/enable_gpu_boost 1
		writen /sys/module/ged/parameters/enable_game_self_frc_detect 1
		writen /sys/module/ged/parameters/gpu_idle 0
		writen /proc/cpufreq/cpufreq_power_mode 3
		writen /proc/cpufreq/cpufreq_cci_mode 1
		writen /sys/devices/system/cpu/eas/enable 0
		writen /sys/devices/system/cpu/perf/enable 1
		writen /proc/gpufreq/gpufreq_opp_freq 6969000
		writen /proc/ppm/enabled 1
		writen /proc/ppm/policy_status 1
		writen /sys/devices/system/cpu/cpufreq/policy0/scaling_governor performance
		writen /sys/devices/system/cpu/cpufreq/policy4/scaling_governor performance
		writen /sys/devices/system/cpu/cpufreq/policy6/scaling_governor performance
		writen /sys/block/mmcblk0/queue/scheduler deadline
		writen /sys/block/mmcblk1/queue/scheduler deadline
		writen /sys/block/sda/queue/scheduler deadline
		writen /sys/block/sdb/queue/scheduler deadline
		writen /sys/block/sdc/queue/scheduler deadline
		writen /proc/ppm/policy/hard_userlimit_max_cpu_freq 6969000
		writen /proc/ppm/policy/hard_userlimit_min_cpu_freq 6969000
		writen /proc/touchpanel/game_switch_enable 1
		writen /proc/touchpanel/oppo_tp_direction 1
		writen /sys/kernel/oppo_display/cabc 0
		writen /dev/cpuset/foreground/cpus 0-7
		writen /dev/cpuset/background/cpus 0-7
		writen /dev/cpuset/system-background/cpus 0-7
		writen /dev/cpuset/top-app/cpus 0-7
		writen /dev/cpuset/restricted/cpus
		writen /dev/stune/background/schedtune.util.max 1
		writen /dev/stune/background/schedtune.util.min 1
		writen /dev/stune/background/schedtune.boost 1
		writen /dev/stune/background/schedtune.prefer_idle 0
		writen /dev/stune/foreground/schedtune.util.max.effective 1
		writen /dev/stune/foreground/schedtune.util.min.effective 0
		writen /dev/stune/foreground/schedtune.util.max 1024
		writen /dev/stune/foreground/schedtune.util.min 0
		writen /dev/stune/foreground/schedtune.boost 13
		writen /dev/stune/foreground/schedtune.prefer_idle 0
		writen /dev/stune/top-app/schedtune.util.max.effective 1024
		writen /dev/stune/top-app/schedtune.util.min.effective 0
		writen /dev/stune/top-app/schedtune.util.max 1024
		writen /dev/stune/top-app/schedtune.util.min 0
		writen /dev/stune/top-app/schedtune.boost 20
		writen /dev/stune/top-app/schedtune.prefer_idle 0
		writen /dev/stune/schedtune.util.min 1024
		writen /dev/stune/schedtune.util.max 1024
		writen /dev/stune/schedtune.util.max.effective 1024
		writen /dev/stune/schedtune.util.min.effective 0
		writen /dev/stune/schedtune.boost 2
		writen /dev/stune/schedtune.prefer_idle 0
		writen /sys/module/pm_hotplug/parameters/loadl 40
		writen /sys/module/pm_hotplug/parameters/loadh 90
		writen /sys/module/pm_hotplug/parameters/loadl_scroff 50
		writen /sys/module/pm_hotplug/parameters/loadh_scroff 100
		writen /sys/module/pm_hotplug/parameters/rate 100
		writen /sys/module/pm_hotplug/parameters/rate_cpuon 400
		writen /sys/module/pm_hotplug/parameters/rate_scroff 400
		writen /sys/module/pm_hotplug/parameters/freq_cpu1on 500000
		writen /sys/devices/system/cpu/cpu0/cpufreq/smooth_target 1
		writen /sys/devices/system/cpu/cpu0/cpufreq/smooth_offset 1
		writen /sys/devices/system/cpu/cpu0/cpufreq/smooth_step 1
	}
	set_battery_mode()
	{
		resetprop ro.nitron.mode green
		writen /proc/sys/kernel/perf_cpu_time_max_percent 2
		writen /proc/sys/kernel/sched_autogroup_enabled 1
		writen /proc/sys/kernel/sched_child_runs_first 0
		writen /proc/sys/kernel/sched_tunable_scaling 0
		writen /proc/sys/kernel/sched_migration_cost_ns 5000000
		writen /proc/sys/kernel/sched_nr_migrate 256
		writen /proc/sys/kernel/sched_schedstats 0
		writen /proc/sys/kernel/printk_devkmsg off
		writen /proc/sys/vm/dirty_background_ratio 2
		writen /proc/sys/vm/dirty_ratio 5
		writen /proc/sys/vm/dirty_expire_centisecs 500
		writen /proc/sys/vm/dirty_writeback_centisecs 500
		writen /proc/sys/vm/page-cluster 0
		writen /proc/sys/vm/stat_interval 10
		writen /proc/sys/vm/swappiness 100
		writen /proc/sys/vm/vfs_cache_pressure 100
		writen /proc/sys/net/ipv4/tcp_ecn 1
		writen /proc/sys/net/ipv4/tcp_fastopen 3
		writen /proc/sys/net/ipv4/tcp_syncookies 0
		writen /sys/module/ged/parameters/gx_game_mode 0
		writen /sys/module/ged/parameters/gx_force_cpu_boost 0
		writen /sys/module/ged/parameters/boost_amp 0
		writen /sys/module/ged/parameters/boost_extra 0
		writen /sys/module/ged/parameters/boost_gpu_enable 0
		writen /sys/module/ged/parameters/enable_cpu_boost 0
		writen /sys/module/ged/parameters/enable_gpu_boost 0
		writen /sys/module/ged/parameters/enable_game_self_frc_detect 0
		writen /sys/module/ged/parameters/gpu_idle 100
		writen /sys/block/mmcblk0/queue/scheduler noop
		writen /sys/block/mmcblk1/queue/scheduler noop
		writen /sys/block/sda/queue/scheduler noop
		writen /sys/block/sdb/queue/scheduler noop
		writen /proc/cpufreq/cpufreq_power_mode 1
		writen /proc/cpufreq/cpufreq_cci_mode 0
		writen /sys/devices/system/cpu/eas/enable 1
		writen /sys/devices/system/cpu/perf/enable 0
		writen /proc/gpufreq/gpufreq_opp_freq 99000
		writen /proc/ppm/enabled 0
		writen /proc/ppm/policy_status 1
		writen /sys/devices/system/cpu/cpufreq/policy0/scaling_governor powersave
		writen /sys/devices/system/cpu/cpufreq/policy4/scaling_governor schedutil
		writen /sys/devices/system/cpu/cpufreq/policy6/scaling_governor schedutil
		writen /proc/ppm/policy/hard_userlimit_max_cpu_freq 998000
		writen /proc/ppm/policy/hard_userlimit_min_cpu_freq 850000
		writen /proc/touchpanel/game_switch_enable 1
		writen /proc/touchpanel/oppo_tp_direction 1
		writen /sys/kernel/oppo_display/cabc 0
		writen /dev/cpuset/foreground/cpus 0-5
		writen /dev/cpuset/background/cpus 0-7
		writen /dev/cpuset/system-background/cpus 0-7
		writen /dev/cpuset/top-app/cpus 0-7
		writen /dev/cpuset/restricted/cpus
		writen /dev/stune/background/schedtune.util.max.effective 0
		writen /dev/stune/background/schedtune.util.min.effective 0
		writen /dev/stune/background/schedtune.util.max 0
		writen /dev/stune/background/schedtune.util.min 0
		writen /dev/stune/background/schedtune.boost 0
		writen /dev/stune/background/schedtune.prefer_idle 1
		writen /dev/stune/foreground/schedtune.util.max.effective 1
		writen /dev/stune/foreground/schedtune.util.min.effective 0
		writen /dev/stune/foreground/schedtune.util.max 1
		writen /dev/stune/foreground/schedtune.util.min 0
		writen /dev/stune/foreground/schedtune.boost 0
		writen /dev/stune/foreground/schedtune.prefer_idle 1
		writen /dev/stune/top-app/schedtune.util.max.effective 0
		writen /dev/stune/top-app/schedtune.util.min.effective 0
		writen /dev/stune/top-app/schedtune.util.max 128
		writen /dev/stune/top-app/schedtune.util.min 0
		writen /dev/stune/top-app/schedtune.boost 0
		writen /dev/stune/top-app/schedtune.prefer_idle 1
		writen /dev/stune/schedtune.util.min 0
		writen /dev/stune/schedtune.util.max 512
		writen /dev/stune/schedtune.util.max.effective 512
		writen /dev/stune/schedtune.util.min.effective 0
		writen /dev/stune/schedtune.boost 0
		writen /dev/stune/schedtune.prefer_idle 1
	}
	set_balance_mode()
	{
		resetprop ro.nitron.mode yellow
		writen /proc/sys/kernel/perf_cpu_time_max_percent 5
		writen /proc/sys/kernel/sched_autogroup_enabled 1
		writen /proc/sys/kernel/sched_child_runs_first 1
		writen /proc/sys/kernel/sched_tunable_scaling 0
		writen /proc/sys/kernel/sched_migration_cost_ns 5000000
		writen /proc/sys/kernel/sched_nr_migrate 32
		writen /proc/sys/kernel/sched_schedstats 0
		writen /proc/sys/kernel/printk_devkmsg off
		writen /proc/sys/vm/dirty_background_ratio 10
		writen /proc/sys/vm/dirty_ratio 30
		writen /proc/sys/vm/dirty_expire_centisecs 3000
		writen /proc/sys/vm/dirty_writeback_centisecs 3000
		writen /proc/sys/vm/page-cluster 0
		writen /proc/sys/vm/stat_interval 10
		writen /proc/sys/vm/swappiness 100
		writen /proc/sys/vm/vfs_cache_pressure 100
		writen /proc/sys/net/ipv4/tcp_ecn 1
		writen /proc/sys/net/ipv4/tcp_fastopen 3
		writen /proc/sys/net/ipv4/tcp_syncookies 0
		writen /sys/module/ged/parameters/gx_game_mode 0
		writen /sys/module/ged/parameters/gx_force_cpu_boost 0
		writen /sys/module/ged/parameters/boost_amp 0
		writen /sys/module/ged/parameters/boost_extra 0
		writen /sys/module/ged/parameters/boost_gpu_enable 0
		writen /sys/module/ged/parameters/enable_cpu_boost 0
		writen /sys/module/ged/parameters/enable_gpu_boost 0
		writen /sys/module/ged/parameters/enable_game_self_frc_detect 0
		writen /sys/module/ged/parameters/gpu_idle 100
		writen /proc/cpufreq/cpufreq_power_mode 0
		writen /proc/cpufreq/cpufreq_cci_mode 0
		writen /sys/devices/system/cpu/eas/enable 2
		writen /sys/devices/system/cpu/perf/enable 0
		writen /proc/gpufreq/gpufreq_opp_freq 0
		writen /sys/block/mmcblk0/queue/scheduler cfq
		writen /sys/block/mmcblk1/queue/scheduler cfq
		writen /sys/block/sda/queue/scheduler cfq
		writen /sys/block/sdb/queue/scheduler cfq
		writen /sys/devices/system/cpu/cpufreq/policy0/scaling_governor schedutil
		writen /sys/devices/system/cpu/cpufreq/policy4/scaling_governor schedutil
		writen /sys/devices/system/cpu/cpufreq/policy6/scaling_governor schedutil
		writen /proc/ppm/policy/hard_userlimit_max_cpu_freq 2000000
		writen /proc/ppm/policy/hard_userlimit_min_cpu_freq 850000
		writen /proc/ppm/policy/hard_userlimit_max_cpu_freq 1700000
		writen /proc/ppm/policy/hard_userlimit_min_cpu_freq 500000
		writen /proc/touchpanel/game_switch_enable 1
		writen /proc/touchpanel/oppo_tp_direction 1
		writen /sys/kernel/oppo_display/cabc 1
		writen /dev/cpuset/foreground/cpus 0-7
		writen /dev/cpuset/background/cpus 0-6
		writen /dev/cpuset/system-background/cpus 0-4
		writen /dev/cpuset/top-app/cpus 0-7
		writen /dev/cpuset/restricted/cpus 0
		writen /dev/stune/background/schedtune.util.max.effective 0
		writen /dev/stune/background/schedtune.util.min.effective 0
		writen /dev/stune/background/schedtune.util.max 0
		writen /dev/stune/background/schedtune.util.min 0
		writen /dev/stune/background/schedtune.boost 0
		writen /dev/stune/foreground/schedtune.util.max.effective 1024
		writen /dev/stune/foreground/schedtune.util.min.effective 1024
		writen /dev/stune/foreground/schedtune.util.max 1024
		writen /dev/stune/foreground/schedtune.util.min 0
		writen /dev/stune/foreground/schedtune.boost 0
		writen /dev/stune/top-app/schedtune.util.max.effective 1024
		writen /dev/stune/top-app/schedtune.util.min.effective 0
		writen /dev/stune/top-app/schedtune.util.max 1024
		writen /dev/stune/top-app/schedtune.util.min 0
		writen /dev/stune/top-app/schedtune.boost 0
		writen /dev/stune/schedtune.util.min 0
		writen /dev/stune/schedtune.util.max 0
		writen /dev/stune/schedtune.util.max.effective 1024
		writen /dev/stune/schedtune.util.min.effective 0
		writen /dev/stune/schedtune.boost 0
	}

	        case $* in
			"-g"|"--green") set_battery_mode ; return $? ;;
			"-r"|"--red") set_gaming_mode ; return $? ;;
			"-y"|"--yellow") set_balance_mode ; return $? ;;
			"-h"|"--help") __magicn_help ;;
			*) printn -e "Unknown Option  $@"; __magicn_help ;;
	        esac
}

updaten()
{
	printn -n "checking connectivity..."
	if [[ $(getprop ro.nitron.forcecheckupdate) == "no" ]]
	then
		printn -e "aborted from system variable"
		echo "[$(date +%I:%M:%S)] $0: ${arg#*}: ro.nitron.forcecheckupdate == $(getprop ro.nitron.forcecheckupdate)" >> $NITRON_LOG_DIR/nitron.log
		return 1
	elif [[ ${NITRON_FORCECHECK_UPDATE} == "false" ]]
	then
		printn -e "aborted from system variable"
		echo "[$(date +%I:%M:%S)] $0: ${arg#*}: NITRON_FORCECHECK_UPDATE == ${NITRON_FORCECHECK_UPDATE}" >> $NITRON_LOG_DIR/nitron.log
		return 1
	else
		echo "[$(date +%I:%M:%S)] $0: ${arg#*}: pinging 8.8.8.8 ..." >> $NITRON_LOG_DIR/nitron.log
		if [[ $(ping -c1 "8.8.8.8" > /dev/null && echo $?) == '0' ]]
  		then
			echo "[$(date +%I:%M:%S)] $0: ${arg#*}: failed, returned to $?" >> $NITRON_LOG_DIR/nitron.log
			return $?
  		else
			printn -i "looking for update..."
			wget -O "/cache/nitrond_src_cache" "https://raw.githubusercontent.com/UsiFX/OpenNitroN/main/nitrond"
			if diff "$0" "/cache/nitrond_src_cache"
			then
      				printn -i "updating..."
      				cat "/cache/nitrond_src_cache" > $0
      				printn -n "updated successfully."
      				return $?
    			else
      				printn -n "up to date."
      				return $?
    			fi
		fi
	fi
}


### we need root of, course...
if [[ "$(id -u)" -ne 0 ]]
then
	printn -e "Please run with Super User."
	exit 1
fi

if [[ $(grep -nr "androidboot" /proc/cmdline) ]]
then
    echo "[$(date +%I:%M:%S)] $0: working in android platform, using resetprop algorithm..." >> $NITRON_LOG_DIR/nitron.log
	resetprop ro.nitron.forcecheckupdate no
	resetprop ro.nitron.version 0.7.1
	if [[ ! $(getprop ro.nitron.version) ]]
	then

    	echo "[$(date +%I:%M:%S)] $0: we are working on first use, Supplying initial mode..." >> $NITRON_LOG_DIR/nitron.log
		resetprop ro.nitron.mode default
	fi
else
    echo "[$(date +%I:%M:%S)] $0: working in Unknown Linux platform, using export algorithm..." >> $NITRON_LOG_DIR/nitron.log
	export NITRON_FORCECHECK_UPDATE='false'
	export NITRON_VERSION='0.7.1'
	if [[ ! -e "$NITRON_MODE" ]]
	then
		echo "[$(date +%I:%M:%S)] $0: we are working on first use, Supplying initial mode..." >> $NITRON_LOG_DIR/nitron.log
		export NITRON_MODE='default'
	fi
fi

__nitron_help()
{
cat <<EOF
Usage: nitron [-sg] [-sr] [-sy] [-h] [-v]

Options:
  -sg, --set-green ~ apply Battery mode
  -sr, --set-red ~ apply Gaming mode
  -sy, --set-yellow ~ apply Balanced mode
  -sdm, --show-default-mode ~ prints current tweaking mode
  -u, --update ~ force update to latest
  -h, --help ~ shows this Help menu
  -v, --version ~ shows tool version
EOF
}

if [[ $# -eq "0" ]] && tty -s
then
	__nitron_help
else
	case $@ in
		"-sg"|"--set-green")
			magicn -g
			if [[ $(grep -nr "androidboot" /proc/cmdline) ]]
			then
				printn -n "$0: current mode set to: $(getprop ro.nitron.mode)"
			else
				printn -n "$0: current mode set to: ${NITRON_MODE}"
			fi
		;;
		"-sr"|"--set-red")
			magicn -r
			if [[ $(grep -nr "androidboot" /proc/cmdline) ]]
			then
				printn -n "$0: current mode set to: $(getprop ro.nitron.mode)"
			else
				printn -n "$0: current mode set to: ${NITRON_MODE}"
			fi
		;;
		"-sy"|"--set-yellow")
			magicn -y
			if [[ $(grep -nr "androidboot" /proc/cmdline) ]]
			then
				printn -n "$0: current mode set to: $(getprop ro.nitron.mode)"
			else
				printn -n "$0: current mode set to: ${NITRON_MODE}"
			fi
		;;
		"-sdm"|"--show-default-mode") 
			if [[ $(grep -nr "androidboot" /proc/cmdline) ]]
			then
				echo -e "$0: mode: $(getprop ro.nitron.mode)"
			else
				echo -e "$0: mode: ${NITRON_MODE}"
			fi
		;;
		"-v"|"--version")
			if [[ $(grep -nr "androidboot" /proc/cmdline) ]]
			then
				echo -e "nitrond $(getprop ro.nitron.version)"
			else
				echo -e "nitrond ${NIRON_VERSION}"
			fi
		;;
		"-c"|"--console-mode")
			if ! hash dialog 2>/dev/null
			then
				echo "[$(date +%I:%M:%S)] $0: dialog not found, switch: console_legacy()" >> $NITRON_LOG_DIR/nitron.log
				console_legacy
			else
				console_dialog
				echo "[$(date +%I:%M:%S)] $0: console_dialog(): started" >> $NITRON_LOG_DIR/nitron.log
			fi
		;;
		"-h"|"--help") __nitron_help ;;
		"-u"|"--update") updaten ;;
		*) printn -e "Unknown Option  $@"; __nitron_help ;;
	esac
fi
